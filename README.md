# FolderSnapshot.py - 文件与文件夹快照工具

`FolderSnapshot.py` 是一个功能强大且易于使用的命令行工具，用于将单个文件或整个文件夹结构打包成一个独立的文本文件（快照）。这个工具支持压缩和非压缩两种模式，可以完美地处理文本和二进制文件，并能从快照文件中精确地恢复原始文件和目录结构。

这个工具的核心设计理念是**可移植性**和**易用性**。您只需要一个 Python 环境，就可以轻松地在不同操作系统（Windows, macOS, Linux）之间备份、恢复或传输复杂的文件结构。

## ✨ 功能特性

- **文件夹/文件打包**: 可以对指定的文件或整个文件夹进行快照。
- **两种快照模式**:
  - **无压缩**: 生成人类可读的文本格式，便于检查和修改。
  - **高压缩**: 使用 LZMA 算法对快照进行高效压缩，极大减小文件体积，便于存储和传输。
- **智能文件处理**: 自动检测文件是文本还是二进制，并采用相应的方式（UTF-8 或 Base64）进行编码，确保数据无损。
- **精确恢复**: 从快照文件恢复时，能够完整地重建原始的目录层级和所有文件。
- **跨平台兼容**: 脚本可在 Windows、macOS 和 Linux 上稳定运行。
- **交互式界面**: 提供清晰的命令行菜单，引导用户完成操作。
- **从剪贴板恢复**: 支持直接从编辑器粘贴内容进行恢复，工具会自动判断快照格式（压缩或未压缩）。
- **用户友好的提示**: 在处理文件时提供实时进度条，并对关键操作和错误提供彩色高亮提示。
- **鲁棒性**: 即使快照文件部分损坏，工具也会尝试恢复尽可能多的数据，并对错误进行提示。

## ⚙️ 环境要求

- **Python 3.6+**
- **colorama** (可选): 在 Windows 系统上提供彩色的命令行输出。如果未安装，程序仍可正常运行，只是输出为黑白文本。

建议通过 `requirements.txt` 文件安装所有依赖。

```bash
pip install -r requirements.txt
```

## 🚀 如何使用

直接通过 Python 运行脚本即可启动交互式菜单。

```bash
python3 FolderSnapshot.py
```

启动后，您会看到以下菜单：

```
=== 文件快照工具 (v5.1 高效安全版) by WilsonShi ===
--- 从文件创建/恢复 ---
1. 创建快照文件 (无压缩，支持所有文件类型)
2. 创建高压缩率快照文件 (LZMA)
3. 从快照文件恢复
4. 从压缩快照恢复
--- 通过文本编辑器恢复 ---
5. 通过编辑器粘贴内容恢复 (自动判断格式)
0. 退出
```

### 操作指南

- **选项 1: 创建无压缩快照**
  - 输入 `1` 并按回车。
  - 输入您想要打包的文件或文件夹的路径。
  - 程序将生成一个 `snapshot_*.txt` 文件，其中包含了所有文件和目录的信息。

- **选项 2: 创建压缩快照**
  - 输入 `2` 并按回车。
  - 输入您想要打包的文件或文件夹的路径。
  - 程序将生成一个 `compressed_snapshot_*.txt` 文件，这是经过 LZMA 压缩和 Base85 编码的版本。

- **选项 3: 从无压缩快照恢复**
  - 输入 `3` 并按回车。
  - 输入快照文件 (`.txt`) 的路径。
  - 输入一个目标文件夹路径，文件将被恢复到该位置。

- **选项 4: 从压缩快照恢复**
  - 输入 `4` 并按回车。
  - 输入压缩快照文件 (`.txt`) 的路径。
  - 输入一个目标文件夹路径，文件将被恢复到该位置。

- **选项 5: 从编辑器粘贴内容恢复**
  - 这个功能非常适合从聊天窗口、邮件等地方直接复制快照内容进行恢复。
  - 输入 `5` 并按回车。
  - 程序会自动打开您系统的默认文本编辑器（如 Vim, Nano, Notepad）。
  - 将快照内容粘贴到编辑器中，保存并关闭。
  - 输入一个目标文件夹路径。
  - 程序会自动检测内容是压缩还是未压缩格式，并进行恢复。

## 📄 快照格式说明

了解快照格式有助于高级用户进行调试或手动修改。

### 无压缩格式

无压缩的快照由多个条目（entry）组成，每个条目代表一个文件或目录。

```
--- entry ---
{"path": "my_folder/my_file.txt", "type": "file", "encoding": "utf-8", "size": 123}
这是文件的内容...
--- entry ---
{"path": "my_folder/image.png", "type": "file", "encoding": "base64", "size": 4567}
(Base64编码的二进制内容)...
--- entry ---
{"path": "my_folder/empty_subdir", "type": "dir"}
```

- `--- entry ---`: 每个文件/目录的开始标记。
- **元数据 (JSON)**: 紧跟在标记后面的一行 JSON，描述了路径、类型（`file` 或 `dir`）、编码方式和大小。
- **文件内容**: 如果条目是文件，其内容会紧跟在元数据之后。

### 压缩格式

压缩的快照文件由两部分组成：

```
{"version": "1.0", "compression_method": "lzma", "original_size": 12345}
---SNAPSHOT_METADATA_END---
(经过LZMA压缩和Base85编码的长字符串)...
```

- **元数据 (JSON)**: 文件开头是一个描述版本、压缩方法和原始大小的 JSON 对象。
- **分隔符**: `---SNAPSHOT_METADATA_END---` 用于分隔元数据和压缩内容。
- **压缩数据**: 文件余下的部分是经过处理的压缩数据。

## 🧪 如何测试

项目包含一个完整的测试套件，以确保所有功能的稳定性和正确性。

1.  **安装测试依赖**:
    ```bash
    pip install pytest
    ```
    (如果已通过 `requirements.txt` 安装，则可跳过此步)

2.  **运行测试**:
    在项目根目录下运行以下命令：
    ```bash
    python3 -m pytest test_folder_snapshot.py
    ```

测试套件将自动创建临时文件和目录，对所有功能（包括特殊文件名、空目录、损坏文件等边缘情况）进行全面的自动化测试。
